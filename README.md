# CloudWatch Event Format

This AWS Lambda function takes CloudWatch Events and tries to format them using
custom templates before publishing them to an SNS Topic. This will produce an
email that is much easier to read than the default, and also deliver to other
endpoints the same as before.

- **License:** University of Illinois/NCSA Open Source License
- **Organization:** University of Illinois at Urbana-Champaign, Technology Services
- **Author:** [Stephen J. Butler](mailto:stephen.butler@gmail.com)

## Lambda Function

The next couple sections describe the low level operation and building of the
Lambda function. If you want to deploy this yourself, we recommend you only do
the build phase and then skip to the Terraform section.

### Building

This is a NodeJS 10.x project that builds using Gulp. Building should be as
simple as running these commands from the project directory:

```bash
npm install
npm run-script build
```

This produces two files in the `dist` directory.

| File                  | Description |
| --------------------- | ----------- |
| cweventFormat.zip     | Main project source files and templates. |
| cweventFormat-lib.zip | All the project dependencies, packaged as a Lambda Layer. |

### Deploying

Since the dependencies are packaged separately (so that you can use the Lambda
code editor), you will need to create a Lambda Layer for it.

You will also need a role for the Lambda function. It needs standard Lambda
execution permissions (CloudWatch Logs), and the trusted entity will be the
Lambda service. In addition, it will need permissions to use `sns:Publish` on
the target SNS Topic.

When creating the Lambda Function there are a couple important environment
variables:

| Name          | Default | Description |
| ------------- | ------- | ----------- |
| SNS_TOPIC_ARN |         | The ARN of the target SNS Topic to send events to after formatting. |
| TZ            | UTC     | When formatting some timestamps, which timezone to display them in. You can use names like `America/Chicago`, `America/Denver`, etc. |

Once the function is created you can create rules to trigger it. Make sure your
rules add the correct permissions for `events.amazonaws.com` to the function
policy.

Alternately, use the terraform module provided.

## Terraform

A terraform module and example are provided to simplify deployment of this
function. Before using the terraform you will need to upload the zip files in
`dist` to an S3 bucket for the terraform to deploy from.

### Resources

The terraform module will create and manage these resources for you:

- **SNS Topic:** if you do not pass in the ARN of an SNS Topic then one will be created
  for you.
- **Lambda Role and Policies:** IAM role and policies used by the Lambda function to
  publish to the SNS Topic and write CloudWatch Logs. No other permissions are
  needed at this time.
- **Lambda Layer:** layer to hold the dependencies, deployed from the
  `s3://deploy_bucket/deploy_libkey`.
- **Lambda Function:** part that does all the work to format events for publishing,
  deployed from the `s3://deploy_bucket/deploy_key`. The Lambda Function also
  uses the SNS Topic as a Dead Letter Queue (DLQ) for failed events.
- **CloudWatch Log Group:** for logs generated by the Lambda Function.
- **CloudWatch Metric Alarm:** alarm that alerts on errors in the Lambda Function.
  This publishes to the SNS Topic.

### Variables: Cloud First

These variables are defined by the Cloud First initiative.

| Name        | Default | Description |
| ----------- | ------- | ----------- |
| service     |         | Service name (match Service Catalog where possible). |
| contact     |         | Service email address. |
| environment | ""      | Production, Test, Development, Green, Blue, etc. |
| revision    | ""      | Revision identified for this green-blue deployment. |

### Variables: Common

These variables are used by the project and are common to many of the components
it manages.

| Name                   | Default | Description |
| ---------------------- | ------- | ----------- |
| project                |         | Name for the infrastructure project. This will be included in resource names and tags where possible. Something short, all lowercase, and simple. |
| deploy_bucket          |         | Bucket name to deploy the lambda code from. |
| deploy_key             |         | Bucket key that specifies the zip file for the cweventFormat function. |
| deploy_libkey          |         | Bucket key that specified the zip file for the libs of the cweventForamt function. |
| notification_topic_arn | ""      | SNS Topic to send formatted notifications to. If you do not specify a value here then an SNS Topic is created for you. |
| event_rule_patterns    | {}      | CloudWatch Event Rules patterns in a map of NAME = PATTERN. You do not need to specify patterns here, and can instead do them in your own terraform code. If you do, you will need a `aws_cloudwatch_event_rule`, `aws_cloudwatch_event_target`, and `aws_lambda_permission` resources for each pattern. |

### Variables: Lambda

These variables are used to configure the Lambda Function.

| Name            | Default         | Description |
| --------------- | --------------- | ----------- |
| lambda_name     | "cweventFormat" | Base name (without the project) to use for the lambda function name. The project and revision will be added as a prefix to this. |
| lambda_timezone | "UTC"           | Timezone name to set when running the lambda function ("America/Chicago", "UTC", etc). |

### Variables: Logs

These variables control where the Lambda Function logs are sent and how long they
are retained. You will always have a copy of the logs in CloudWatch Logs, but you
can also have a copy sent to another Lambda Function or a Log Destination (for
cross-account logging).

| Name                  | Default | Description |
| --------------------- | ------- | ----------- |
| log_retention_in_days | 30      | Number of days to retain log streams in CloudWatch Logs. |
| log_subscription_arn  | ""      | Lambda function ARN or CloudWatch Logs Destination to subscribe to this log group. |

### Outputs

These outputs are useful for other parts of your terraform.

- lambda_role_name
- lambda_role_arn
- lambda_function_name
- lambda_arn
- notification_topic_arn

### Example

Take a look at the `terraform/0.11/example` directory for how to use this module.
